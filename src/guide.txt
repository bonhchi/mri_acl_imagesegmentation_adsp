# ğŸ§  Image Segmentation MRI â€“ FastMRI Pipeline (RTX 3060 + Python 3.13)

## 1ï¸âƒ£ Chuáº©n bá»‹ mÃ´i trÆ°á»ng
cd /d D:\Master\ImageSegmentation\Demo

python -m venv .venv
call .venv\Scripts\activate

python -m pip install --upgrade pip setuptools wheel
pip install -r requirements.txt

âš ï¸ Náº¿u bÃ¡o thiáº¿u thÆ° viá»‡n dotenv â†’ cÃ i thÃªm:
pip install python-dotenv


## 2ï¸âƒ£ Kiá»ƒm tra dá»¯ liá»‡u fastMRI
Dá»¯ liá»‡u `.h5` náº±m trong:
D:\Master\ImageSegmentation\Demo\dataset\singlecoil_train

Kiá»ƒm tra:
dir /s /b D:\Master\ImageSegmentation\Demo\dataset\singlecoil_train\*.h5

Náº¿u cÃ³ file `.h5` â†’ cháº¡y lá»‡nh sau Ä‘á»ƒ thá»­ adapter:
python -m src.main --dataset fastmri --root "D:\Master\ImageSegmentation\Demo\dataset\singlecoil_train"
âœ… Náº¿u tháº¥y â€œDataset size: â€¦â€ nghÄ©a lÃ  Ä‘á»c Ä‘Æ°á»£c dá»¯ liá»‡u.


## 3ï¸âƒ£ Preprocess thÃ nh volume (.npz / .pt)
python -m src.main ^
  --dataset fastmri ^
  --root "D:\Master\ImageSegmentation\Demo\dataset\singlecoil_train" ^
  --root_dir "D:\Master\ImageSegmentation\Demo\dataset\singlecoil_train" ^
  --out_dir artifacts\fastmri_knee ^
  --preview_max 6

Káº¿t quáº£:
artifacts\fastmri_knee\<case_id>\volume.npz
                                \tensor.pt
                                \masks\
                                \preview.png
                                \summary.json


## 4ï¸âƒ£ Táº¡o danh sÃ¡ch train/val
:: Gom táº¥t cáº£ volume.npz vÃ o danh sÃ¡ch
for /r artifacts\fastmri_knee %f in (volume.npz) do @echo %f>>all.txt

:: Chia 80/20 train/val
python - <<EOF
import random, pathlib
p=pathlib.Path("all.txt")
L=[l.strip() for l in p.read_text().splitlines() if l.strip()]
random.seed(42); random.shuffle(L)
k=int(len(L)*0.8)
pathlib.Path("lists").mkdir(exist_ok=True)
pathlib.Path("lists/train.txt").write_text("\n".join(L[:k]))
pathlib.Path("lists/val.txt").write_text("\n".join(L[k:]))
print("Train:",k," Val:",len(L)-k)
EOF


## 5ï¸âƒ£ Train U-Net (2D/2.5D)
python -m src.train.train_unet ^
  --train-list lists\train.txt ^
  --val-list lists\val.txt ^
  --out-dir runs\fastmri_unet ^
  --epochs 20 ^
  --batch-size 8 ^
  --workers 4 ^
  --amp

Náº¿u lá»—i â€œCUDA out of memoryâ€ â†’ giáº£m batch size:
--batch-size 4

Káº¿t quáº£:
runs\fastmri_unet\best.ckpt
runs\fastmri_unet\history.csv
runs\fastmri_unet\samples_epXX\


## 6ï¸âƒ£ Theo dÃµi báº±ng TensorBoard
tensorboard --logdir runs\fastmri_unet
â†’ Má»Ÿ http://localhost:6006


## 7ï¸âƒ£ Inference (tuá»³ chá»n)
python -m src.infer --ckpt runs\fastmri_unet\best.ckpt


## ğŸ§© Ghi chÃº thÃªm
| ThÃ nh pháº§n | Ã nghÄ©a |
|-------------|----------|
| .env | Khai bÃ¡o Ä‘Æ°á»ng dáº«n dataset (FASTMRI_ROOT, KNEE_MRI_ROOT, â€¦) |
| artifacts/ | Dá»¯ liá»‡u Ä‘Ã£ preprocess (volume.npz, mask, tensor.pt) |
| lists/ | Danh sÃ¡ch train / val |
| runs/ | Log training, checkpoint, sample áº£nh |
| src/ | MÃ£ nguá»“n chÃ­nh (adapter, train, infer, utils, â€¦) |


## âœ… Kiá»ƒm tra nhanh GPU vÃ  mÃ´i trÆ°á»ng
python - <<EOF
import torch, monai
print("Torch:", torch.__version__, "CUDA available:", torch.cuda.is_available())
if torch.cuda.is_available():
    print("GPU:", torch.cuda.get_device_name(0))
print("MONAI:", monai.__version__)
EOF
